<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mini app</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- 1. Telegram Mini App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        :root {
            --bg-color: #121212; --primary-color: #1A1A1A; --secondary-color: #2C2C2C;
            --accent-color: #9EFF00; --accent-glow: rgba(158, 255, 0, 0.3);
            --text-color: #E5E7EB; --text-muted: #9CA3AF;
            --error-color: #F87171; --success-color: #3fb950;
            --theme-color: #0088cc; /* ক্লেইম বাটনের জন্য একটি নতুন কালার */
        }
        body { margin: 0; font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: var(--text-color); display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .app-container { width: 100%; max-width: 400px; height: 100vh; max-height: 850px; background-color: var(--primary-color); border-radius: 24px; box-shadow: 0 0 50px rgba(0, 0, 0, 0.8); display: flex; flex-direction: column; overflow: hidden; position: relative; border: 1px solid #374151; }
        main { flex-grow: 1; padding: 20px; overflow-y: auto; scrollbar-width: none; }
        main::-webkit-scrollbar { display: none; }
        .screen { display: none; width: 100%; flex-direction: column; align-items: center; }
        .screen.active { display: flex; animation: slideInUp 0.5s ease-out; }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        #splash-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #FFFFFF; z-index: 999; display: flex;
            justify-content: center; align-items: center; transition: opacity 0.5s ease-out;
        }
        #splash-screen img { width: 220px; height: 220px; object-fit: contain; animation: popIn 0.8s ease-out; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        #splash-screen.hidden { opacity: 0; pointer-events: none; }
        h2 { color: var(--text-color); text-align: center; width: 100%; margin-top: 0; margin-bottom: 25px; font-size: 24px; font-weight: 500; }
        .btn { background: var(--accent-color); color: var(--primary-color); font-weight: bold; cursor: pointer; text-align: center; border: none; transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s; padding: 16px; font-size: 18px; border-radius: 12px; width: 100%; box-sizing: border-box; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 20px var(--accent-glow); }
        .btn:disabled { background: #374151; color: #6B7280; cursor: not-allowed; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: var(--primary-color); border-bottom: 1px solid #374151; flex-shrink: 0; }
        .profile-info { display: flex; align-items: center; gap: 12px; }
        .profile-avatar { width: 45px; height: 45px; border-radius: 50%; background-size: cover; background-position: center; border: 2px solid var(--accent-color); background-color: var(--secondary-color);}
        #username-header { font-size: 18px; font-weight: 500; }
        footer { padding: 10px 0; background-color: var(--primary-color); margin-top: auto; border-top: 1px solid #374151; flex-shrink: 0; }
        .bottom-nav { display: flex; justify-content: space-around; }
        .nav-btn { background: none; border: none; color: #6B7280; cursor: pointer; font-size: 30px; transition: color 0.2s, transform 0.2s; padding: 5px; }
        .nav-btn.active, .nav-btn:hover { color: var(--accent-color); transform: translateY(-3px); }
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background-color: var(--secondary-color); color: var(--text-color); padding: 12px 20px; border-radius: 8px; z-index: 200; opacity: 0; transition: opacity 0.3s, bottom 0.3s; font-size: 14px; text-align: center;}
        .balance-amount { font-size: 38px; font-weight: 700; margin: 8px 0; color: var(--accent-color); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; margin-bottom: 25px; }
        .stat-card { background-color: var(--secondary-color); border-radius: 12px; padding: 15px; display: flex; align-items: center; gap: 12px; }
        .stat-card .material-icons { font-size: 28px; color: var(--accent-color); }
        .stat-card .stat-info { line-height: 1.3; }
        .stat-card .stat-value { font-size: 18px; font-weight: 700; margin: 0; }
        .stat-card .stat-label { font-size: 12px; color: var(--text-muted); margin: 0; }
        .mining-card { width: 100%; text-align: center; background-color: var(--secondary-color); padding: 20px; border-radius: 16px; box-sizing: border-box; }
        .list-container { width: 100%; display: flex; flex-direction: column; gap: 12px; }
        .list-item { background-color: var(--secondary-color); padding: 12px 15px; border-radius: 12px; display: flex; align-items: center; border: 1px solid #374151; gap: 12px; }
        .list-item-image { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; flex-shrink: 0; background-color: var(--primary-color); }
        .list-item-info { flex-grow: 1; }
        .form-group { width: 100%; margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 14px; }
        input, select { width: 100%; background-color: var(--secondary-color); border: 1px solid #374151; color: var(--text-color); padding: 12px; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .input-group { display: flex; align-items: center; }
        .input-group input { border-radius: 8px 0 0 8px; flex-grow: 1; }
        .input-group .btn { width: auto; font-size: 14px; padding: 12px 14px; border-radius: 0; display: flex; align-items: center; gap: 5px; }
        .input-group .btn:last-child { border-radius: 0 8px 8px 0; }
        .section-title { font-size: 18px; font-weight: 500; color: var(--text-color); width: 100%; margin: 25px 0 15px; text-align: left; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 99; display: none; justify-content: center; align-items: center; }
        .modal { background: #1F2937; border-radius: 16px; padding: 25px; z-index: 100; width: 90%; max-width: 360px; display: flex; flex-direction: column; gap: 15px; animation: slideInUp 0.5s; border: 1px solid #374151; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .modal-header h3 { margin: 0; }
        .close-modal { cursor: pointer; }
        .avatar-upload-container { position: relative; align-self: center; margin-bottom: 20px; }
        .settings-avatar { width: 100px; height: 100px; border-radius: 50%; background-size: cover; background-position: center; border: 3px solid var(--accent-color); cursor: pointer; background-color: var(--primary-color); }
        .avatar-upload-overlay { position: absolute; bottom: 0; right: 0; background: var(--accent-color); color: var(--primary-color); border-radius: 50%; padding: 5px; display: flex; align-items: center; justify-content: center; pointer-events: none; }
        .task-btn.timer-active { background-color: #4B5563; color: var(--text-color); cursor: pointer; }
        .ad-list-container { width: 100%; display: flex; flex-direction: column; gap: 15px; }
        .ad-card { background-color: var(--secondary-color); border-radius: 12px; padding: 15px; display: flex; align-items: center; gap: 12px; }
        .ad-card .image-container { width: 50px; height: 50px; flex-shrink: 0; }
        .ad-card img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent-color); background-color: var(--primary-color); }
        .ad-info { flex-grow: 1; }
        .ad-info h4 { margin: 0 0 5px; font-size: 18px; font-weight: 500; color: var(--text-color); }
        .ad-info p { margin: 0; color: var(--accent-color); font-weight: bold; font-size: 16px; }
        .ad-watch-btn { background-color: #374151; color: var(--text-color); border: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px; min-width: 100px; text-align: center; transition: background-color 0.3s; }
        .ad-watch-btn.available { background-color: var(--theme-color); color: white; }
        .transaction-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background-color: var(--secondary-color); border-radius: 12px; border: 1px solid #374151; }
        .transaction-details p { margin: 0; }
        .transaction-details .type { font-weight: 500; }
        .transaction-details .date { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
        .transaction-amount-wrapper { text-align: right; }
        .transaction-amount { font-weight: bold; }
        .transaction-amount.positive { color: var(--accent-color); }
        .transaction-amount.negative { color: var(--error-color); }
        .transaction-status { font-size: 12px; font-weight: bold; padding: 4px 8px; border-radius: 6px; text-transform: capitalize; margin-top: 4px; display: inline-block; }
        .transaction-status.pending { background-color: #f59e0b; color: #111827; }
        .transaction-status.approved { background-color: var(--success-color); color: white; }
        .transaction-status.rejected { background-color: var(--error-color); color: white; }
        .referral-item { background-color: var(--secondary-color); padding: 10px 15px; border-radius: 12px; display: flex; align-items: center; gap: 15px; border: 1px solid #374151; }
        .referral-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent-color); }
        .referral-name { font-size: 16px; font-weight: 500; }
    </style>
</head>
<body>
    <div class="app-container">
        <div id="splash-screen"><img id="splash-image" src="" alt="Loading..."></div>
        <header style="visibility: hidden;">
            <div class="profile-info">
                <div class="profile-avatar" id="profile-avatar-header"></div>
                <span id="username-header">Loading...</span>
            </div>
            <span class="material-icons" id="settings-btn" style="cursor: pointer;">settings</span>
        </header>
        <main style="visibility: hidden;">
            <div id="mining-screen" class="screen active">
                <div style="text-align: center; width: 100%; margin-bottom: 20px;">
                    <p>Total Points Balance</p>
                    <h1 class="balance-amount" id="home-balance">0.00</h1>
                </div>
                <div class="stats-grid">
                    <div class="stat-card"><span class="material-icons">today</span><div class="stat-info"><p class="stat-value" id="dashboard-today-points">0.00</p><p class="stat-label">Today's Earnings</p></div></div>
                    <div class="stat-card"><span class="material-icons">arrow_upward</span><div class="stat-info"><p class="stat-value" id="dashboard-withdrawals">0.00</p><p class="stat-label">Total Withdrawals</p></div></div>
                    <div class="stat-card"><span class="material-icons">people</span><div class="stat-info"><p class="stat-value" id="dashboard-ref-count">0</p><p class="stat-label">Total Referrals</p></div></div>
                    <div class="stat-card"><span class="material-icons">card_giftcard</span><div class="stat-info"><p class="stat-value" id="dashboard-ref-points">0.00</p><p class="stat-label">Referral Earnings</p></div></div>
                    <div class="stat-card"><span class="material-icons">task_alt</span><div class="stat-info"><p class="stat-value" id="dashboard-task-points">0.00</p><p class="stat-label">Task Earnings</p></div></div>
                    <div class="stat-card"><span class="material-icons">military_tech</span><div class="stat-info"><p class="stat-value" id="dashboard-level">Level 1</p><p class="stat-label">Current Level</p></div></div>
                </div>
                <div class="mining-card">
                    <h2>Session Power</h2>
                    <h2 id="mining-reward-display" class="balance-amount" style="font-size: 28px; margin: 10px 0;">...</h2>
                    <button id="start-mining-btn" class="btn">START MINING</button>
                    <p id="mining-timer-text" style="margin-top: 15px; font-size: 14px; color: var(--text-muted);">...</p>
                </div>
            </div>
            <div id="wallet-screen" class="screen">
                <h2>My Wallet</h2>
                <p style="color: var(--text-muted);">Your current balance</p>
                <h1 class="balance-amount" style="margin-bottom: 25px;"><span id="wallet-balance">0.00</span> Points</h1>
                <button id="withdraw-btn" class="btn">Request Withdrawal</button>
                <div class="section-title">Transaction History</div>
                <div id="transaction-list" class="list-container"><p style="color: var(--text-muted); text-align: center;">No transactions yet.</p></div>
            </div>
            <div id="team-screen" class="screen">
                <h2>My Team</h2>
                <p id="referral-info-text" style="text-align: center; color: var(--text-muted); margin-bottom: 20px;">Loading referral info...</p>
                <div class="form-group"><label>Your Referral Link</label><div class="input-group"><input type="text" id="referral-link" readonly><button id="copy-btn" class="btn">Copy</button><button id="share-btn" class="btn" style="display: none; border-left: 1px solid #121212;"><span class="material-icons">share</span></button></div></div>
                <div class="section-title">Your Referrals (<span id="referral-count">0</span>)</div>
                <div id="referral-list" class="list-container"><p style="color: var(--text-muted); text-align: center;">You haven't referred anyone yet.</p></div>
            </div>
            <div id="tasks-screen" class="screen">
                <h2>Daily Tasks</h2>
                <p style="color: var(--text-muted); text-align: center; margin-bottom: 25px;">Complete tasks to earn more points.</p>
                <div id="tasks-list-container" class="list-container"><p style="color: var(--text-muted); text-align: center;">Loading tasks...</p></div>
            </div>
            <div id="ads-screen" class="screen">
                <h2>Watch Ads</h2>
                <div id="ads-list-container" class="ad-list-container"></div>
            </div>
            <div id="settings-screen" class="screen">
                <h2>Settings</h2>
                <div class="avatar-upload-container"><div id="settings-avatar" class="settings-avatar" style="background-image: url('https://i.ibb.co/jPGKy4Jq/1000029438.png');"></div><div class="avatar-upload-overlay"><span class="material-icons">photo_camera</span></div><input type="file" id="avatar-upload-input" accept="image/*" style="display: none;"></div>
                <div class="form-group"><label for="update-username">Username</label><input type="text" id="update-username"></div>
                <div class="form-group"><label for="country-select">Country</label><select id="country-select"></select></div>
                <button id="save-settings-btn" class="btn">Save Changes</button>
            </div>
        </main>
        <footer style="visibility: hidden;">
            <nav class="bottom-nav">
                <button class="nav-btn active" data-target="mining-screen"><span class="material-icons">home</span></button>
                <button class="nav-btn" data-target="tasks-screen"><span class="material-icons">task_alt</span></button>
                <button class="nav-btn" data-target="ads-screen"><span class="material-icons">ads_click</span></button>
                <button class="nav-btn" data-target="team-screen"><span class="material-icons">people</span></button>
                <button class="nav-btn" data-target="wallet-screen"><span class="material-icons">account_balance_wallet</span></button>
            </nav>
        </footer>
    </div>
    <div class="modal-overlay" id="withdraw-modal-overlay">
        <div class="modal">
            <div class="modal-header"><h3>Request Withdrawal</h3><span class="material-icons close-modal" style="cursor:pointer;">close</span></div>
            <p id="withdrawal-rules" style="font-size: 14px; color: var(--text-muted); margin:0;">Loading rules...</p>
            <div class="form-group"><label>Payment Method</label><select id="withdraw-network"><optgroup label="Mobile Banking"><option value="bKash">bKash</option><option value="Nagad">Nagad</option></optgroup><optgroup label="Cryptocurrency"><option value="BEP20">Binance (BEP20)</option></optgroup></select></div>
            <div class="form-group"><label>Account Number / Address</label><input type="text" id="account-info-input"></div>
            <div class="form-group"><label>Amount</label><input type="number" id="withdraw-amount"></div>
            <button id="submit-withdraw-btn" class="btn">Submit Request</button>
        </div>
    </div>
    <div class="toast" id="toast-message"></div>

<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBYGJJVKg8A6S7Y0B5QfsOqZnz7bD89-zs",
      authDomain: "earning-bot-df18d.firebaseapp.com",
      databaseURL: "https://earning-bot-df18d-default-rtdb.firebaseio.com",
      projectId: "earning-bot-df18d",
      messagingSenderId: "315160135551",
      appId: "1:315160135551:web:161f0b6cce0fbc5d61fc4a"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();
    let userId, currentUserData, appSettings, miningInterval, taskTimers = {}, adTimers = {};

    document.addEventListener('DOMContentLoaded', () => {
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
            window.Telegram.WebApp.ready();
            const tgUser = window.Telegram.WebApp.initDataUnsafe.user;

            if (tgUser && tgUser.id) {
                const safeUserId = "tg_" + tgUser.id;
                initializeAppWithUser(safeUserId, tgUser);
            } else {
                initializeAppWithUser(null, null);
            }
        } else {
            initializeAppWithUser(null, null);
        }
    });

    function initializeAppWithUser(uid, tgUser) {
        handleSplashScreen();
        if (uid) {
            userId = uid;
            listenForThemeChanges();
            database.ref('settings').on('value', snap => {
                appSettings = snap.val();
                if (currentUserData) updateUI(currentUserData);
            });
            initializeUser(userId, tgUser);
        } else {
            auth.onAuthStateChanged(user => {
                if (user) {
                    userId = user.uid;
                    listenForThemeChanges();
                    database.ref('settings').on('value', snap => {
                        appSettings = snap.val();
                        if (currentUserData) updateUI(currentUserData);
                    });
                    initializeUser(userId, null);
                } else {
                    auth.signInAnonymously().catch(error => console.error("Anonymous sign-in failed:", error));
                }
            });
        }
    }
    
    function initializeUser(uid, tgUser = null) {
        const userRef = database.ref('users/' + uid);

        userRef.on('value', (snapshot) => {
            if (!snapshot.exists()) {
                let newUser;
                if (tgUser) {
                    const fullName = `${tgUser.first_name || ''} ${tgUser.last_name || ''}`.trim();
                    newUser = {
                        userId: uid,
                        username: fullName || tgUser.username || `tg_user_${tgUser.id}`,
                        telegramUsername: tgUser.username || 'Not available',
                        balance: 0,
                        avatar: tgUser.photo_url || 'https://i.ibb.co/jPGKy4Jq/1000029438.png', 
                        country: "Bangladesh",
                        joinDate: new Date().toISOString(),
                        referralCode: Math.random().toString(36).substring(2, 8).toUpperCase(),
                        transactions: {}, referrals: {}, miningSession: { active: false, endTime: 0 }, completedTasks: {}, completedAds: {}
                    };
                } else {
                    newUser = {
                        userId: uid, username: `user${Math.floor(1000 + Math.random() * 9000)}`, balance: 0,
                        avatar: 'https://i.ibb.co/jPGKy4Jq/1000029438.png', country: "Bangladesh",
                        joinDate: new Date().toISOString(), referralCode: Math.random().toString(36).substring(2, 8).toUpperCase(),
                        transactions: {}, referrals: {}, miningSession: { active: false, endTime: 0 }, completedTasks: {}, completedAds: {}
                    };
                }
                
                const urlParams = new URLSearchParams(window.location.search);
                const refCodeFromUrl = urlParams.get('ref');
                const refCodeFromTg = (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe.start_param) ? window.Telegram.WebApp.initDataUnsafe.start_param : null;
                const refCode = refCodeFromTg || refCodeFromUrl;


                if (refCode) grantRewardToReferrer(refCode, uid);
                
                userRef.set(newUser);
                return;
            }
            
            currentUserData = snapshot.val();
            updateUI(currentUserData);
            setupEventListeners();
            populateCountries();
        });
    }

    async function handleSplashScreen() {
        const splashScreen = document.getElementById('splash-screen');
        const splashImage = document.getElementById('splash-image');
        try {
            const snapshot = await database.ref('settings').once('value');
            const settings = snapshot.val() || {};
            const imageUrl = settings.splashImageUrl || 'https://i.ibb.co/VtXW0Bf/mini-app-logo.png';
            const duration = (settings.splashDurationSeconds || 5) * 1000;
            splashImage.src = imageUrl;
            setTimeout(() => {
                splashScreen.classList.add('hidden');
                document.querySelector('header').style.visibility = 'visible';
                document.querySelector('main').style.visibility = 'visible';
                document.querySelector('footer').style.visibility = 'visible';
            }, duration);
        } catch (error) {
            setTimeout(() => { 
                splashScreen.classList.add('hidden');
                document.querySelector('header').style.visibility = 'visible';
                document.querySelector('main').style.visibility = 'visible';
                document.querySelector('footer').style.visibility = 'visible';
            }, 5000);
        }
    }

    function listenForThemeChanges() {
        database.ref('theme_settings').on('value', (snapshot) => {
            if (snapshot.exists()) {
                const theme = snapshot.val();
                const root = document.documentElement;
                const updateVar = (varName, value) => value && root.style.setProperty(varName, value);
                updateVar('--bg-color', theme.primaryColor);
                updateVar('--primary-color', theme.primaryColor);
                updateVar('--secondary-color', theme.secondaryColor);
                updateVar('--accent-color', theme.accentColor);
                updateVar('--text-color', theme.textColor);
                updateVar('--text-muted', theme.textMuted);
            }
        });
    }
    
    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        const screen = document.getElementById(screenId);
        if (screen) {
            screen.classList.add('active');
            if (screenId === 'ads-screen') loadAndDisplayAds();
            else if (screenId === 'tasks-screen') loadAndDisplayTasks();
            else if (screenId === 'wallet-screen') loadTransactionHistory();
            else if (screenId === 'team-screen') loadReferralList();
            else if (screenId === 'settings-screen' && currentUserData) {
                document.getElementById('settings-avatar').style.backgroundImage = `url(${currentUserData.avatar})`;
                document.getElementById('update-username').value = currentUserData.username;
                document.getElementById('country-select').value = currentUserData.country;
            }
        }
    }

    function loadReferralList() {
        const container = document.getElementById('referral-list');
        const referrals = currentUserData.referrals || {};
        const referralIds = Object.keys(referrals).filter(id => !id.startsWith('manual_'));
        if (referralIds.length === 0) {
            container.innerHTML = `<p style="color: var(--text-muted); text-align: center;">You haven't referred anyone yet.</p>`;
            return;
        }
        container.innerHTML = `<p style="color: var(--text-muted); text-align: center;">Loading referrals...</p>`;
        const promises = referralIds.map(id => database.ref('users/' + id).once('value'));
        Promise.all(promises).then(snapshots => {
            container.innerHTML = '';
            snapshots.forEach(snap => {
                if (snap.exists()) {
                    const referredUser = snap.val();
                    const item = document.createElement('div');
                    item.className = 'referral-item';
                    const avatar = referredUser.avatar || 'https://i.ibb.co/jPGKy4Jq/1000029438.png';
                    const username = referredUser.username || 'Unknown User';
                    item.innerHTML = `<img src="${avatar}" class="referral-avatar" alt="Avatar"><p class="referral-name">${username}</p>`;
                    container.appendChild(item);
                }
            });
        }).catch(error => {
            console.error("Error loading referrals:", error);
            container.innerHTML = `<p style="color: var(--error-color); text-align: center;">Could not load referrals.</p>`;
        });
    }
    
    function loadAndDisplayAds() {
        if (!currentUserData) return;
        const container = document.getElementById('ads-list-container');
        container.innerHTML = `<p style="text-align:center; color: var(--text-muted);">Loading ads...</p>`;
        database.ref('users/' + userId + '/completedAds').on('value', async () => {
             const adsSnap = await database.ref('ads').once('value');
             const userSnap = await database.ref('users/' + userId).once('value');
             currentUserData = userSnap.val();
             const ads = adsSnap.val() || {};
             container.innerHTML = '';
             Object.values(adTimers).forEach(clearInterval);
             adTimers = {};
             if (Object.keys(ads).length === 0) {
                 container.innerHTML = `<p style="color: var(--text-muted); text-align: center;">No ads available.</p>`;
                 return;
             }
             for (const adId in ads) {
                 const ad = ads[adId];
                 const adCard = document.createElement('div');
                 adCard.className = 'ad-card';
                 adCard.innerHTML = `
                     <div class="image-container"><img src="${ad.imageUrl}" alt="Ad"></div>
                     <div class="ad-info"><h4>${ad.title}</h4><p>+${ad.reward} Points</p></div>
                     <button class="ad-watch-btn" id="ad-btn-${adId}">Loading...</button>`;
                 container.appendChild(adCard);
                 updateAdButtonState(document.getElementById(`ad-btn-${adId}`), ad, adId);
             }
        });
    }

    function updateAdButtonState(button, ad, adId) {
        if (!currentUserData || !button) return;
        button.dataset.reward = ad.reward;
        button.dataset.link = ad.link;
        button.dataset.adId = adId;
        const completedAds = currentUserData.completedAds || {};
        const lastCompletionTime = completedAds[adId];
        const cooldownSeconds = ad.timer || 86400;
        const cooldownMillis = cooldownSeconds * 1000;
        button.disabled = false;
        if (lastCompletionTime) {
            const unlockTime = lastCompletionTime + cooldownMillis;
            if (Date.now() < unlockTime) {
                startAdCountdown(button, unlockTime, adId);
                button.dataset.claimable = "false";
            } else {
                if (adTimers[adId]) clearInterval(adTimers[adId]);
                button.innerText = 'Claim Reward';
                button.classList.add('available');
                button.classList.remove('timer-active');
                button.dataset.claimable = "true";
            }
        } else {
            button.innerText = 'Claim Reward';
            button.classList.add('available');
            button.classList.remove('timer-active');
            button.dataset.claimable = "true";
        }
        button.removeEventListener('click', handleAdClick);
        button.addEventListener('click', handleAdClick);
    }

    function startAdCountdown(button, unlockTime, adId) {
        if (adTimers[adId]) clearInterval(adTimers[adId]);
        button.classList.remove('available');
        button.classList.add('timer-active');
        const update = () => {
            const timeLeft = unlockTime - Date.now();
            if (timeLeft <= 0) {
                clearInterval(adTimers[adId]);
                button.innerText = 'Claim Reward';
                button.classList.add('available');
                button.classList.remove('timer-active');
                button.dataset.claimable = "true";
            } else {
                const h = String(Math.floor(timeLeft / 3600000)).padStart(2, '0');
                const m = String(Math.floor((timeLeft % 3600000) / 60000)).padStart(2, '0');
                const s = String(Math.floor((timeLeft % 60000) / 1000)).padStart(2, '0');
                button.innerText = `${h}:${m}:${s}`;
            }
        };
        update();
        adTimers[adId] = setInterval(update, 1000);
    }

    async function handleAdClick(event) {
        const button = event.currentTarget;
        const adId = button.dataset.adId;
        const reward = parseFloat(button.dataset.reward);
        const link = button.dataset.link;
        const isClaimable = button.dataset.claimable === "true";
        if (link && link !== 'undefined' && link !== "null") {
            window.Telegram.WebApp.openLink(link);
        }
        if (isClaimable) {
            button.dataset.claimable = "false"; 
            button.disabled = true;
            button.innerText = "Claiming...";
            try {
                await database.ref(`users/${userId}/completedAds/${adId}`).set(firebase.database.ServerValue.TIMESTAMP);
                await database.ref(`users/${userId}/balance`).transaction(bal => (bal || 0) + reward);
                const tx = { type: 'ad_reward', amount: reward, adId: adId, date: new Date().toISOString() };
                await database.ref(`users/${userId}/transactions`).push().set(tx);
                showToast(`You earned ${reward} points!`, 'success');
            } catch (error) {
                showToast("An error occurred while claiming.", 'error');
                button.disabled = false;
                button.innerText = "Claim Reward";
                button.dataset.claimable = "true";
            }
        } else {
            showToast("You can view the ad, but the reward is on cooldown.", "info");
        }
    }
    
    function loadAndDisplayTasks() {
        if (!currentUserData) return;
        const tasksRef = database.ref('tasks');
        tasksRef.on('value', async (snapshot) => {
            const tasks = snapshot.val() || {};
            const container = document.getElementById('tasks-list-container');
            container.innerHTML = '';
            Object.values(taskTimers).forEach(clearInterval); taskTimers = {};
            const userSnap = await database.ref('users/' + userId).once('value');
            currentUserData = userSnap.val();
            if (Object.keys(tasks).length === 0) { container.innerHTML = `<p style="color: var(--text-muted); text-align: center;">No tasks available.</p>`; return; }
            for (const taskId in tasks) {
                const task = tasks[taskId];
                const listItem = document.createElement('div');
                listItem.className = 'list-item';
                const imageUrl = task.imageUrl || 'https://i.ibb.co/VtXW0Bf/mini-app-logo.png'; 
                listItem.innerHTML = `
                    <img src="${imageUrl}" class="list-item-image" alt="Task">
                    <div class="list-item-info">
                        <p style="margin:0;font-weight:500;">${task.title}</p>
                        <p style="margin:5px 0 0;font-size:14px;color:var(--accent-color);">+${task.reward} Points</p>
                    </div>
                    <button class="btn task-btn" id="task-btn-${taskId}" data-task-id="${taskId}" style="width:auto;padding:8px 16px;font-size:14px;">Loading...</button>`;
                container.appendChild(listItem);
                updateTaskButtonState(listItem.querySelector('.task-btn'), task, taskId);
            }
        });
    }

    function updateTaskButtonState(button, task, taskId) {
        if (!currentUserData || !button) return;
        const completedTasks = currentUserData.completedTasks || {};
        const lastCompletionTime = completedTasks[taskId];
        button.dataset.reward = task.reward; button.dataset.link = task.link;
        const bonusTimeSeconds = task.bonusTime || 0;
        const bonusTimeMillis = bonusTimeSeconds * 1000;
        if (bonusTimeMillis > 0) {
            if (lastCompletionTime) {
                const unlockTime = lastCompletionTime + bonusTimeMillis;
                if (Date.now() < unlockTime) { 
                    startTaskCountdown(button, unlockTime, taskId); 
                } else { 
                    button.innerText = 'Claim'; 
                    button.disabled = false; 
                    button.classList.remove('timer-active');
                }
            } else { 
                button.innerText = 'Claim'; 
                button.disabled = false; 
            }
        } else {
            if (lastCompletionTime) { 
                button.innerText = 'Claimed'; 
                button.disabled = true; 
            } else { 
                button.innerText = 'Claim'; 
                button.disabled = false; 
            }
        }
        button.removeEventListener('click', handleTaskClick);
        button.addEventListener('click', handleTaskClick);
    }
    
    function startTaskCountdown(button, unlockTime, taskId) {
        if (taskTimers[taskId]) clearInterval(taskTimers[taskId]);
        const updateTimer = () => {
            const timeLeft = unlockTime - Date.now();
            if (timeLeft <= 0) {
                clearInterval(taskTimers[taskId]); 
                button.innerText = 'Claim'; 
                button.disabled = false; 
                button.classList.remove('timer-active');
            } else {
                const h = String(Math.floor(timeLeft / 3600000)).padStart(2, '0');
                const m = String(Math.floor((timeLeft % 3600000) / 60000)).padStart(2, '0');
                const s = String(Math.floor((timeLeft % 60000) / 1000)).padStart(2, '0');
                button.innerText = `${h}:${m}:${s}`; 
                button.classList.add('timer-active');
            }
        };
        updateTimer(); 
        taskTimers[taskId] = setInterval(updateTimer, 1000);
    }
    
    async function handleTaskClick(event) {
        const button = event.currentTarget;
        const taskId = button.dataset.taskId;
        const taskSnap = await database.ref('tasks/' + taskId).once('value');
        const task = taskSnap.val();
        if (!task) return;
        const link = task.link;
        if (link && link !== 'undefined' && link !== "null") {
             window.Telegram.WebApp.openLink(link);
        }
        const userSnap = await database.ref('users/' + userId).once('value');
        currentUserData = userSnap.val();
        const completedTasks = currentUserData.completedTasks || {};
        const lastCompletionTime = completedTasks[taskId];
        const bonusTimeSeconds = task.bonusTime || 0;
        let isClaimable = (bonusTimeSeconds > 0) ? (!lastCompletionTime || Date.now() >= (lastCompletionTime + bonusTimeSeconds * 1000)) : !lastCompletionTime;
        if (isClaimable) {
            button.disabled = true; button.innerText = 'Processing...';
            try {
                const reward = parseFloat(task.reward);
                await database.ref(`users/${userId}/completedTasks/${taskId}`).set(firebase.database.ServerValue.TIMESTAMP);
                await database.ref(`users/${userId}/balance`).set(firebase.database.ServerValue.increment(reward));
                const tx = { type: 'task_reward', amount: reward, taskId: taskId, date: new Date().toISOString() };
                await database.ref(`users/${userId}/transactions`).push().set(tx);
                showToast(`You earned ${reward} points!`);
            } catch (error) {
                 showToast('An error occurred. Please try again.', 'error');
                 button.disabled = false; button.innerText = 'Claim';
            }
        } else if (lastCompletionTime) { 
            showToast("Please wait for the timer to finish.", "info"); 
        }
    }
    
    function setupEventListeners() {
        document.querySelectorAll('.nav-btn').forEach(btn => btn.addEventListener('click', (e) => {
            const targetId = e.currentTarget.dataset.target; showScreen(targetId);
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); e.currentTarget.classList.add('active');
        }));
        document.getElementById('settings-btn').addEventListener('click', () => showScreen('settings-screen'));
        document.getElementById('settings-avatar').addEventListener('click', () => document.getElementById('avatar-upload-input').click());
        document.getElementById('avatar-upload-input').addEventListener('change', handleAvatarUpload);
        document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
        document.getElementById('withdraw-btn').addEventListener('click', () => {
            const minPoints = appSettings?.minWithdrawalPoints || 2000;
            const minRefs = appSettings?.minReferrals || 20;
            document.getElementById('withdrawal-rules').innerText = `Minimum: ${minPoints} Points & ${minRefs} Referrals`;
            document.getElementById('withdraw-amount').placeholder = minPoints;
            document.getElementById('withdraw-modal-overlay').style.display = 'flex';
        });
        document.querySelector('#withdraw-modal-overlay .close-modal').addEventListener('click', () => document.getElementById('withdraw-modal-overlay').style.display = 'none');
        document.getElementById('submit-withdraw-btn').addEventListener('click', submitWithdrawal);
        document.getElementById('start-mining-btn').addEventListener('click', startMining);
        document.getElementById('copy-btn').addEventListener('click', copyReferralLink);
        const shareBtn = document.getElementById('share-btn');
        if (navigator.share) { 
            shareBtn.style.display = 'flex'; 
            shareBtn.addEventListener('click', shareReferralLink); 
        }
    }
    
    async function handleAvatarUpload(event) {
        const file = event.target.files[0];
        if (!file || !file.type.startsWith('image/')) return showToast('Please select an image file.', 'error');
        if (file.size > 1048576) return showToast('Image size should be less than 1MB.', 'error');
        showToast('Uploading...', 'info');
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            try { await database.ref('users/' + userId).update({ avatar: reader.result }); showToast('Profile photo updated!'); } 
            catch (error) { showToast('Upload failed. Please try again.', 'error'); }
        };
        reader.onerror = () => showToast('Could not read the file.', 'error');
    }

    async function saveSettings() {
        const newUsername = document.getElementById('update-username').value.trim(), newCountry = document.getElementById('country-select').value;
        if (newUsername.length < 3) return showToast('Username must be at least 3 characters.', 'error');
        await database.ref('users/' + userId).update({ username: newUsername, country: newCountry });
        showToast('Settings saved!'); showScreen('mining-screen');
    }
    
    function copyReferralLink() {
        const textToCopy = document.getElementById('referral-link').value;
        if (!textToCopy) return;
        navigator.clipboard.writeText(textToCopy).then(() => showToast('Referral link copied!'), () => showToast('Could not copy link.', 'error'));
    }

    async function shareReferralLink() { 
        const link = document.getElementById('referral-link').value;
        const text = 'Join me on this cool app!';
        if (navigator.share) {
            try { await navigator.share({ title: 'Join Me!', text: text, url: link }); } catch (err) { console.error("Share failed:", err); } 
        }
    }

    function updateUI(data) {
        if (!data || !appSettings) return;
        const txs = data.transactions || {}, refs = data.referrals || {};
        document.getElementById('home-balance').innerText = (data.balance || 0).toFixed(2);
        document.getElementById('dashboard-today-points').innerText = calculateTodaysEarnings(txs).toFixed(2);
        document.getElementById('dashboard-withdrawals').innerText = calculateTotalWithdrawals(txs).toFixed(2);
        document.getElementById('dashboard-ref-count').innerText = Object.keys(refs).length;
        document.getElementById('dashboard-ref-points').innerText = calculateReferralEarnings(txs).toFixed(2);
        document.getElementById('dashboard-task-points').innerText = calculateTaskEarnings(txs).toFixed(2);
        document.getElementById('dashboard-level').innerText = `Level ${calculateLevel(data.balance || 0).index}`;
        document.getElementById('username-header').innerText = data.username;
        document.getElementById('profile-avatar-header').style.backgroundImage = `url(${data.avatar})`;
        document.getElementById('wallet-balance').innerText = (data.balance || 0).toFixed(2);
        
        if(document.getElementById('referral-link')) {
            document.getElementById('referral-link').value = `https://t.me/miniapp_24_bot/Mini_app?startapp=${data.referralCode}`;
        }

        if(document.getElementById('referral-count')) document.getElementById('referral-count').innerText = Object.keys(refs).length;
        if(document.getElementById('referral-info-text')) {
            const rewardAmount = appSettings?.referralReward || 50;
            document.getElementById('referral-info-text').innerHTML = `Invite your friends and earn <b style="color: var(--accent-color);">${rewardAmount} Points</b> for each successful referral!`;
        }
        
        const miningReward = appSettings?.miningReward || 200;
        document.getElementById('mining-reward-display').innerText = `${miningReward} Points`;
        updateMiningUI(data.miningSession);
    }

    async function grantRewardToReferrer(refCode, newUserId) {
        const usersRef = database.ref('users');
        const snap = await usersRef.orderByChild('referralCode').equalTo(refCode).once('value');
        if (snap.exists()) {
            const refId = Object.keys(snap.val())[0];
            const rewardAmount = appSettings?.referralReward || 50;
            await database.ref(`users/${refId}/balance`).set(firebase.database.ServerValue.increment(rewardAmount));
            await database.ref(`users/${refId}/referrals/${newUserId}`).set(true);
            const tx = { type: 'referral_bonus', amount: rewardAmount, from: newUserId, date: new Date().toISOString() };
            await database.ref(`users/${refId}/transactions`).push().set(tx);
            await database.ref(`users/${newUserId}/referredBy`).set(refId);
        }
    }
    function calculateTodaysEarnings(txs) { return Object.values(txs || {}).filter(tx=>tx.date?.slice(0,10) === new Date().toISOString().slice(0,10) && tx.amount > 0).reduce((s,t)=>s+t.amount,0); }
    function calculateTotalWithdrawals(txs) { return Object.values(txs || {}).filter(tx=>tx.type === 'withdrawal_request' && tx.status === 'approved').reduce((s,t)=>s+Math.abs(t.amount),0); }
    function calculateReferralEarnings(txs) { return Object.values(txs || {}).filter(tx=>tx.type === 'referral_bonus').reduce((s,t)=>s+t.amount,0); }
    function calculateTaskEarnings(txs) { return Object.values(txs || {}).filter(tx=>tx.type === 'task_reward' || tx.type === 'ad_reward').reduce((s,t)=>s+t.amount,0); }
    function calculateLevel(b) { return b >= 10000 ? {index: 3} : (b >= 2500 ? {index: 2} : {index: 1}); }

    // MINING FUNCTIONS - UPDATED LOGIC
    async function startMining() {
        if (!userId || !appSettings) return showToast("User not identified or settings not loaded.", "error");

        const btn = document.getElementById('start-mining-btn');
        const userRef = database.ref('users/' + userId);
        
        const snapshot = await userRef.once('value');
        const userData = snapshot.val();
        const session = userData.miningSession || {};

        if (session.active && Date.now() < session.endTime) {
            return showToast("Mining session is already active.", "error");
        }

        btn.disabled = true;
        btn.innerText = 'CLAIMING...';

        try {
            const miningReward = appSettings.miningReward || 200;
            const miningDurationHours = appSettings.miningDurationHours || 3;
            const miningDurationSeconds = miningDurationHours * 3600;
            const endTime = Date.now() + (miningDurationSeconds * 1000);
            
            const tx = { type: 'mining_reward', amount: miningReward, date: new Date().toISOString() };
            
            const updates = {};
            updates['/balance'] = firebase.database.ServerValue.increment(miningReward);
            updates['/miningSession'] = { active: true, endTime: endTime };
            updates['/transactions/' + database.ref().push().key] = tx;
            
            await userRef.update(updates);
            showToast(`You earned ${miningReward} points!`, 'success');
        } catch (error) {
            showToast('An error occurred. Please try again.', 'error');
            console.error("Mining Start Error:", error);
            btn.disabled = false;
        }
    }
    
    function updateMiningUI(session) {
        if (!appSettings) return; 
        const btn = document.getElementById('start-mining-btn');
        const timerTextEl = document.getElementById('mining-timer-text');
        const miningDurationHours = appSettings.miningDurationHours || 3;
        clearInterval(miningInterval);
        
        if (session?.active && session.endTime > Date.now()) {
            btn.disabled = true;
            btn.innerText = 'MINING...';
            miningInterval = setInterval(() => {
                const left = session.endTime - Date.now();
                if (left <= 0) {
                    clearInterval(miningInterval);
                    timerTextEl.innerText = `Your next session is ready!`;
                    btn.disabled = false;
                    btn.innerText = 'START MINING';
                } else {
                    const h = String(Math.floor(left / 3600000)).padStart(2, '0');
                    const m = String(Math.floor((left % 3600000) / 60000)).padStart(2, '0');
                    const s = String(Math.floor((left % 60000) / 1000)).padStart(2, '0');
                    timerTextEl.innerText = `Next session in: ${h}h ${m}m ${s}s`;
                }
            }, 1000);
        } else {
            btn.disabled = false;
            btn.innerText = 'START MINING';
            timerTextEl.innerText = `Start a ${miningDurationHours}-hour session`;
        }
    }
    
    // END MINING FUNCTIONS

    async function sendTelegramNotification(details) {
        const botToken = "7770968378:AAER1ubec14YNX6MfjscwbcisqHW_SZXtDw";
        const chatId = "6864733991";
        const message = `<b>🔔 New Withdrawal Request! 🔔</b>
<b>User Name:</b> ${details.username}
<b>User ID:</b> <code>${details.userId}</code>
<b>Amount:</b> ${details.amount} Points
<b>Method:</b> ${details.method}
<b>Account:</b> <code>${details.account}</code>`;
        
        const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
        
        try {
            await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: chatId,
                    text: message,
                    parse_mode: 'HTML',
                }),
            });
        } catch (error) {
            console.error('Error sending Telegram message:', error);
        }
    }
    
    async function submitWithdrawal(event) {
        if (!userId) return showToast("User not identified.", "error");
        const amount = parseFloat(document.getElementById('withdraw-amount').value);
        const method = document.getElementById('withdraw-network').value;
        const account = document.getElementById('account-info-input').value.trim();
        const minPoints = appSettings?.minWithdrawalPoints || 2000;
        const refCount = currentUserData.referrals ? Object.keys(currentUserData.referrals).length : 0;
        const requiredRefs = appSettings?.minReferrals || 20;

        if (refCount < requiredRefs) { return showToast(`You need at least ${requiredRefs} referrals. You have ${refCount}.`, 'error'); }
        if (isNaN(amount) || amount < minPoints) { return showToast(`Minimum withdrawal is ${minPoints} points.`, 'error'); }
        if (amount > currentUserData.balance) { return showToast("You don't have enough points.", 'error'); }
        if (!account) { return showToast('Please enter your account details.', 'error'); }
        
        const btn = event.target; 
        btn.disabled = true; btn.innerText = 'Submitting...';
        
        try {
            const reqRef = database.ref('withdrawals').push();
            const withdrawalId = reqRef.key;
            const reqData = { withdrawalId, userId, amount, account, status: 'pending', method: method, username: currentUserData.username, date: firebase.database.ServerValue.TIMESTAMP };
            await reqRef.set(reqData);
            const userTx = { type: 'withdrawal_request', amount: -amount, date: new Date().toISOString(), status: 'pending', withdrawalId: withdrawalId };
            await database.ref('users/' + userId + '/transactions').push().set(userTx);
            await database.ref('users/' + userId + '/balance').set(firebase.database.ServerValue.increment(-amount));
            await sendTelegramNotification({ username: currentUserData.username, userId: userId, amount: amount, method: method, account: account });
            showToast('Withdrawal request submitted!'); 
            document.getElementById('withdraw-modal-overlay').style.display = 'none';
        } catch (error) { 
            showToast('An error occurred. Please try again.', 'error'); 
        } finally { 
            btn.disabled = false; btn.innerText = 'Submit Request'; 
        }
    }
    
    function loadTransactionHistory() {
        if (!userId) return;
        const container = document.getElementById('transaction-list');
        container.innerHTML = `<p style="color: var(--text-muted); text-align: center;">Loading history...</p>`;
        const userTransactionsRef = database.ref(`users/${userId}/transactions`).orderByChild('date');
        userTransactionsRef.on('value', snapshot => {
            if (!snapshot.exists()) {
                container.innerHTML = `<p style="color: var(--text-muted); text-align: center;">No transactions yet.</p>`;
                return;
            }
            container.innerHTML = '';
            const transactions = [];
            snapshot.forEach(childSnapshot => {
                transactions.push({ id: childSnapshot.key, ...childSnapshot.val() });
            });
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            transactions.forEach(tx => {
                const item = document.createElement('div');
                item.className = 'transaction-item';
                const date = new Date(tx.date).toLocaleString();
                let typeText = tx.type.replace(/_/g, ' ').replace(/(?:^|\s)\S/g, a => a.toUpperCase());
                let amountHtml = '';
                if (tx.type === 'withdrawal_request') {
                    typeText = 'Withdrawal';
                    amountHtml = `<div class="transaction-amount-wrapper"><p class="transaction-amount negative">${tx.amount.toFixed(2)}</p><div class="transaction-status ${tx.status}">${tx.status}</div></div>`;
                } else {
                    amountHtml = `<div class="transaction-amount-wrapper"><p class="transaction-amount positive">+${tx.amount.toFixed(2)}</p></div>`;
                }
                item.innerHTML = `<div class="transaction-details"><p class="type">${typeText}</p><p class="date">${date}</p></div>${amountHtml}`;
                container.appendChild(item);
            });
        });
    }

    function populateCountries() { const countries = ["Bangladesh", "India", "Pakistan", "United States", "United Kingdom"]; const select = document.getElementById('country-select'); select.innerHTML = ''; countries.sort().forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; select.appendChild(o); }); }
    function showToast(message, type = 'success') { const toast = document.getElementById('toast-message'); toast.textContent = message; toast.style.backgroundColor = type === 'error' ? 'var(--error-color)' : (type === 'info' ? '#3B82F6' : 'var(--success-color)'); toast.style.opacity = '1'; toast.style.bottom = '90px'; setTimeout(() => { toast.style.opacity = '0'; toast.style.bottom = '80px'; }, 3000); }

    let withdrawalListenerAttached = false;
    function setupWithdrawalListener() {
        if (!userId || withdrawalListenerAttached) return;
        withdrawalListenerAttached = true;
        database.ref('withdrawals').orderByChild('userId').equalTo(userId).on('child_changed', snapshot => {
            const withdrawal = snapshot.val();
            if ((withdrawal.status === 'approved' || withdrawal.status === 'rejected') && snapshot.key) {
                database.ref(`users/${userId}/transactions`).orderByChild('withdrawalId').equalTo(snapshot.key).once('value', txSnap => {
                    if(txSnap.exists()){
                        const txId = Object.keys(txSnap.val())[0];
                        database.ref(`users/${userId}/transactions/${txId}`).update({ status: withdrawal.status });
                    }
                });
            }
        });
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        if (userId) setupWithdrawalListener();
        else {
            const unsubscribe = auth.onAuthStateChanged(user => {
                if (user) { userId = user.uid; setupWithdrawalListener(); unsubscribe(); }
            });
        }
    });

</script>
</body>
</html>
